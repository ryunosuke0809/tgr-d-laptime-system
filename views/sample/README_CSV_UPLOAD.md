# CSVアップロード機能 - 使用ガイド

## 概要
ユーザー管理画面からCSVファイルを使用してユーザーを一括登録できます。

## 対応文字コード

このシステムは以下の文字コードを自動検出して正しく処理します：

### 1. **UTF-8 with BOM** (推奨)
- **使用ツール**: Excel（名前を付けて保存 → CSV UTF-8）
- **BOM**: `EF BB BF`
- **特徴**: 日本語が正しく表示され、Excelでの編集が容易
- **推奨理由**: 最も互換性が高い

### 2. **UTF-8 without BOM**
- **使用ツール**: テキストエディタ（VSCode, Sublime Text等）
- **特徴**: BOMなしでもUTF-8として自動検出
- **注意**: Excelで開くと文字化けする可能性あり（保存時は問題なし）

### 3. **Shift-JIS**
- **使用ツール**: Excel（CSV形式で保存）、旧来の日本語環境
- **特徴**: 日本のExcelでデフォルトで使用される文字コード
- **自動検出**: UTF-8で読めない場合、自動的にShift-JISとして処理

### 4. **UTF-16 LE with BOM**
- **使用ツール**: Excel（一部のバージョン）
- **BOM**: `FF FE`
- **特徴**: 自動検出して正しく変換

## CSVファイル形式

### 必須列
- `id`: ユーザーID（英数字）
- `name`: ユーザー名（日本語可）
- `password`: パスワード
- `company`: 会社区分（「トヨタ」「ダイハツ」「スバル」「その他」のいずれか）
- `expiryDate`: 有効期限（2025-09-01～2025-09-05のいずれか、または空白で無期限）

### オプション列
- `role`: ロール（`user` または `admin`）※デフォルト: `user`

### 列名のバリエーション

以下の列名すべてに対応しています：

#### ユーザーID
- `id`, `ID`, `ユーザーID`

#### 名前
- `name`, `NAME`, `名前`

#### パスワード
- `password`, `PASSWORD`, `パスワード`

#### 会社区分
- `company`, `COMPANY`, `会社区分`, `会社`

#### ロール
- `role`, `ROLE`, `ロール`

#### 有効期限
- `expiryDate`, `expiration_date`, `EXPIRATION_DATE`, `EXPIRYDATE`, `有効期限`

## サンプルCSV

### 基本的な例
```csv
id,name,password,company,role,expiryDate
user001,テストユーザー1,password123,トヨタ,user,2025-09-01
admin001,管理者ユーザー,admin123,ダイハツ,admin,2025-09-02
user002,テストユーザー2,pass456,スバル,user,2025-09-03
user003,テストユーザー3,test789,その他,user,
```

### 日本語列名の例
```csv
ユーザーID,名前,パスワード,会社区分,ロール,有効期限
user004,山田太郎,yamada123,トヨタ,user,2025-09-01
user005,佐藤花子,sato456,ダイハツ,admin,2025-09-04
```

### 大文字列名の例
```csv
ID,NAME,PASSWORD,COMPANY,ROLE,EXPIRATION_DATE
USER006,TEST USER,test123,スバル,user,2025-09-05
```

## Excelでの編集手順

### 1. テンプレートをダウンロード
1. ユーザー管理画面で「CSVテンプレート」ボタンをクリック
2. `users_template.csv` がダウンロードされます

### 2. Excelで開く
1. ダウンロードしたCSVファイルをExcelで開く
2. 日本語が正しく表示されることを確認

### 3. データを編集
1. 必須項目（id, name, password, company, expiryDate）を入力
2. 会社区分は「トヨタ」「ダイハツ」「スバル」「その他」から選択
3. 有効期限は `2025-09-01` ～ `2025-09-05` のいずれかを指定
4. 無期限にする場合は空白にする
5. オプション項目（role）を必要に応じて入力（デフォルト: user）

### 4. 保存
**重要**: 以下のいずれかの方法で保存してください

#### 方法1: CSV UTF-8 (推奨)
1. 「ファイル」→「名前を付けて保存」
2. ファイルの種類: **CSV UTF-8 (コンマ区切り) (*.csv)**
3. 保存

#### 方法2: CSV (Shift-JIS)
1. 「ファイル」→「名前を付けて保存」
2. ファイルの種類: **CSV (コンマ区切り) (*.csv)**
3. 保存
※ システムが自動的にShift-JISとして認識します

### 5. アップロード
1. ユーザー管理画面で「CSVアップロード」ボタンをクリック
2. 保存したCSVファイルを選択
3. 「アップロード」ボタンをクリック
4. 結果を確認

## エラー処理

### 成功/失敗の表示
- **成功件数**: 正常に登録されたユーザー数
- **失敗件数**: 登録できなかったユーザー数
- **エラー詳細**: 失敗した行とその理由

### よくあるエラー

#### 1. 必須項目不足
```
行2: 必須項目が不足しています
```
→ `id`, `name`, `password` のいずれかが空白

#### 2. ユーザーID重複
```
行3: user001 - User ID already exists
```
→ すでに同じIDのユーザーが登録されている

#### 3. ファイルが空
```
CSVファイルが空です
```
→ ヘッダー行のみ、またはデータ行がない

#### 4. CSV形式エラー
```
CSVファイルのフォーマットが不正です
```
→ カンマ区切りになっていない、または形式が不正

## トラブルシューティング

### 文字化けする場合

#### Excel使用時
1. **保存時**: 必ず「CSV UTF-8」形式で保存
2. **確認**: 保存後、メモ帳などで開いて日本語が正しく表示されるか確認

#### テキストエディタ使用時
1. エンコーディングを「UTF-8」または「UTF-8 with BOM」に設定
2. 改行コードは「LF」または「CRLF」どちらでも可

### アップロードできない場合

#### ファイルサイズ制限
- 最大サイズ: **5MB**
- 大量のユーザーを登録する場合は、ファイルを分割してアップロード

#### ファイル形式
- 拡張子が `.csv` であることを確認
- MIMEタイプが `text/csv` であることを確認

## セキュリティ注意事項

### パスワード管理
- CSVファイルには平文パスワードが含まれます
- アップロード後は必ずファイルを安全に削除してください
- 本番環境では初回ログイン時にパスワード変更を促すことを推奨

### アクセス制限
- CSVアップロード機能は管理者のみが使用できます
- 一般ユーザーには表示されません

## システム仕様

### 技術詳細
- **文字コード検出**: BOMチェック → UTF-8検証 → Shift-JISフォールバック
- **CSVパーサー**: RFC 4180準拠のネイティブJavaScript実装
- **クォート対応**: ダブルクォート内のカンマを正しく処理
- **エスケープ**: 連続したダブルクォート (`""`) を1つのクォートとして解釈

### ログ出力
サーバーログに以下の情報が記録されます：
```
[CSV Upload] Detected encoding: utf-8
[UserModel] Creating new user: user001
```

## まとめ

✅ **推奨方法**: ExcelでCSV UTF-8形式で保存  
✅ **対応文字コード**: UTF-8 (BOM有無), Shift-JIS, UTF-16 LE  
✅ **自動検出**: 文字コードは自動的に判別  
✅ **日本語対応**: 完全対応、文字化けなし  
✅ **エラーハンドリング**: 詳細なエラーメッセージ表示  

ご不明な点がございましたら、システム管理者にお問い合わせください。
